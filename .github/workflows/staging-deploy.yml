name: Deploy to Staging
on:
  push:
    branches:
      - master
jobs:
  staging-deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
      - name: Sync files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.STAGING_SCP_UPLOAD_SERVER }}
          password: ${{ secrets.STAGING_SCP_UPLOAD_PASSWORD }}
          username: ${{ secrets.STAGING_SCP_UPLOAD_USER }}
          port: ${{ secrets.STAGING_SCP_UPLOAD_PORT }}
          source: 'audio/*,css/*,fonts/*,img/*,js/*,playground/*,release/*,specifications/*,vendor/*,LICENSE,README.md,index.html'
          target: '/home/rzaahost/staging-kringel-games/progress-station/'
      - name: Send Discord embed notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          AUTHOR: ${{ github.event.head_commit.author.username }}
        run: |
          json=$(jq -n \
            --arg title "ðŸš€ Deployment Complete" \
            --arg url "https://staging.kringel.games/progress-station/" \
            --arg commit_msg "$COMMIT_MSG" \
            --arg commit_url "$COMMIT_URL" \
            --arg author "$AUTHOR" \
            '{
              embeds: [
                {
                  title: $title,
                  color: 5814783,
                  description: ("A new version has been deployed to **" + $url + "**"),
                  fields: [
                    {
                      name: "Commit Message",
                      value: $commit_msg
                    },
                    {
                      name: "Commit URL",
                      value: $commit_url
                    },
                    {
                      name: "Author",
                      value: $author
                    }
                  ]
                }
              ]
            }')

          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$json" \
               "$DISCORD_WEBHOOK"