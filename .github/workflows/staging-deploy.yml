name: Deploy to Staging
on:
  push:
    branches:
      - master
jobs:
  staging-deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
      - name: Sync files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.STAGING_SCP_UPLOAD_SERVER }}
          password: ${{ secrets.STAGING_SCP_UPLOAD_PASSWORD }}
          username: ${{ secrets.STAGING_SCP_UPLOAD_USER }}
          port: ${{ secrets.STAGING_SCP_UPLOAD_PORT }}
          source: 'audio/*,css/*,fonts/*,img/*,js/*,playground/*,release/*,specifications/*,vendor/*,LICENSE,README.md,index.html'
          target: '/home/rzaahost/staging-kringel-games/progress-station/'
      - name: Send Discord embed notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          # Build list of commits, truncating message at first line break
          commit_list=$(echo "$COMMITS_JSON" | jq -r '
            .[] |
            (.message | split("\n") | map(select(length > 0)) | length) as $total_lines |
            "- [`\(.id[0:7])`](" + .url + ") \((.message | split("\n")[0]))" +
            (if $total_lines > 1 then " [\($total_lines - 1) details]" else "" end) +
            " â€” by \(.author.username)"
          ')

          json=$(jq -n \
            --arg title "ðŸš€ Staging Deployment Complete" \
            --arg url "https://staging.kringel.games/progress-station/" \
            --arg commits "$commit_list" \
            '{
              embeds: [
                {
                  title: $title,
                  color: 5814783,
                  description: ("A new version has been deployed to **" + $url + "**\n\n**Commits included:**\n" + $commits)
                }
              ]
            }')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$json" \
            "$DISCORD_WEBHOOK"